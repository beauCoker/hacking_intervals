{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Plots and basic analysis of results\"\noutput: html_notebook\n---\n\n```{r, message=FALSE, warning=FALSE}\nlibrary(ggplot2)\nlibrary(readr)\nlibrary(dplyr)\n```\n\n\n```{r}\nfolder_home <- \"../../../\"\nfolder_in <- paste0(folder_home,\"Results/svm/Tables/\")\nfolder_out <- paste0(folder_home,\"Results/svm/Figures/\")\n\nsave_figs = FALSE #Whether or not to save the figures\n```\n\n```{r}\n### Load data\npropublica = read_csv(paste0(folder_home,\"Data/1_raw/compas-scores-two-years.csv\"))\n\nres_decile = read_csv(paste0(folder_in,'svm_output_bin_decile_score.csv'))\nres_decile3 = read_csv(paste0(folder_in,'svm_output_bin_decile_score3.csv'))\nres_decile8 = read_csv(paste0(folder_in,'svm_output_bin_decile_score8.csv'))\nres_race = read_csv(paste0(folder_in,'svm_output_bin_race.csv'))\n```\n\n\n```{r}\n# Some data processing for the plot\nds = .09\n\ndf_plt <- res_decile %>%\n  mutate(mid=(LB+UB)/2) %>%\n  arrange(decile_score, mid) %>%\n  group_by(decile_score) %>%\n  mutate(rank = 1:n()) %>%\n  mutate(score_jitter = decile_score + ds*1:n() - ds*(n()+1)/2) %>%\n  mutate(two_year_recid = as.factor(two_year_recid)) %>%\n  mutate(is_recid_plt =  ifelse(two_year_recid==1,\"Reoffend\",\"\"))\n```\n\n\n\n```{r}\nid_ann <- c(4704, 2825, 4772, 8731, 9346, 10258, 3338, 7534, 6749, 4797, 40)\nann_line <- filter(df_plt, id%in%id_ann) %>%\n  mutate(yend = UB+.5)\nann_text <- left_join(ann_line,propublica,by=\"id\") %>% ungroup()\n\nscore_min = min(res_decile$decile_score)\nscore_max = max(res_decile$decile_score)\n\np <- ggplot(df_plt, aes(x=score_jitter)) +\n  #geom_segment(data=ann_line,aes(x = score_jitter, xend = score_jitter, y = 20, yend = 0,color=factor(id)), \n  #             size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  geom_text(data=ann_text, aes(x=score_jitter, y=5.5, label=name),angle=90,hjust='left',size=2)+\n  geom_segment(data=ann_line,aes(x = score_jitter, xend = score_jitter, y = 5, yend = yend), \n               color='black',size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  geom_errorbar(aes(ymin=LB, ymax=UB, color=race),\n                width=.05) + \n  geom_point(aes(y=UB+.1, shape=is_recid_plt), size=.8) +\n  scale_shape_manual(values=c(32,16), name=element_blank()) + # values are for Reoffend character\n  geom_hline(yintercept=0, color='grey', linetype=2) +\n  theme_bw() +\n  scale_x_continuous(breaks=seq(score_min,score_max),\n                     limits=c(score_min-0.5, score_max+0.5),\n                     expand=c(0,0))+\n  theme(panel.grid.major.x = element_line(colour=\"white\", size=0.5),\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank(),\n        legend.position=\"bottom\") +\n  xlab(\"COMPAS Score\") +\n  ylab(\"Scaled Distance to Hyperplane\") +\n  scale_color_discrete(name=\"\")\np\n```\n\n```{r}\nif (save_figs){\n  ggsave(paste0(folder_out,\"svm_by_decile.pdf\"),p,width = 8, height = 4, units = \"in\")\n}\n```\n\n------------\n\n### COMPAS score of 3\n\nFraction of people on either side of zero:\n```{r}\nsum(res_decile3$LB<0 & res_decile3$UB > 0 )/nrow(res_decile3)\n```\n\nHow many people had an interval above zero (and a low compas score in this case)?\n```{r}\nres_decile3 %>%\n  filter(LB > 0)\n```\nWhat can we say about this group on average?\n```{r}\nabove0_score3 = filter(propublica, id %in% res_decile3$id[res_decile3$LB>0]) %>%\n  summarize(n_people = n(), mean_prior=mean(priors_count), tot_recid=sum(two_year_recid))\nabove0_score3\n```\n\nOf the `r nrow(res_decile3)` people in our dataset with COMPAS scores of 3, `r above0_score3$n_people` of them had hacking intervals entirely above zero. That is, had SVM been used for prediction, any reasonable model would have predicted that they would reoffend. These people had an average of nearly `r above0_score3$mean_prior` priors and`r above0_score3$tot_recid` of them reoffended. \n\n#This includes 56 year old Dwight Francis (person id 10623) charged with felony petit theft. He had 20 priors including felony petit theft and felony possession of cocaine. Since his COMPAS score was calculated he has been arrested on three occasions for misdomeanor felony petit theft. Update: Dwight Francis no longer has interval above zero. Need to find other example.\n\n\n\n```{r}\n# Some data processing for the plot\nds = .04\n\ndf3_plt <- res_decile3 %>%\n  mutate(mid=(LB+UB)/2) %>%\n  arrange(decile_score, mid) %>%\n  group_by(decile_score) %>%\n  mutate(rank = 1:n()) %>%\n  mutate(score_jitter = decile_score + ds*1:n() - ds*(n()+1)/2) %>%\n  mutate(two_year_recid = as.factor(two_year_recid)) %>%\n  mutate(is_recid_plt =  ifelse(two_year_recid==1,\"Reoffend\",\"\")) %>%\n  mutate(group = if_else(row_number()<=floor(nrow(res_decile3)/3),0,if_else(row_number()>floor(nrow(res_decile3)/3) & row_number()<=floor(nrow(res_decile3)*2/3),2,3)))\n```\n\n\n\n```{r}\nann_line <- data.frame(x = 659, xend = 659, y = -2.5, yend = 0, group=3)\nann_text <- data.frame(x = 650, xend = 659, y = -2.8, yend = 0, group=3)\n\np<-ggplot(df3_plt, aes(x=rank)) +\n  geom_errorbar(aes(ymin=LB, ymax=UB, color=race),\n                width=.05) + \n  geom_point(aes(y=UB+.1, shape=is_recid_plt), size=.8) +\n  scale_shape_manual(values=c(32,16), name=element_blank()) + # values are for Reoffend character\n  geom_hline(yintercept=0, color='grey', linetype=2) +\n  #geom_segment(data=ann_line,aes(x = x, xend = xend, y = y, yend = yend), \n               #colour = \"black\", size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  #geom_text(data=ann_text,aes(x=x,y=y,size=2),label=\"Dwight Francis\",size=3)+\n  facet_wrap(~group ,scales = \"free\",ncol=1) +\n  theme_bw() +\n  scale_x_continuous(expand=c(0.01,0.01)\n                     #                  breaks=seq(score_min,score_max),\n                     #                   limits=c(score_min-0.5, score_max+0.5),\n  )+\n  theme(strip.background = element_blank(),\n        strip.text = element_blank(),\n        #axis.title.x=element_blank(),\n        #axis.text.x=element_blank(),\n        #axis.ticks.x=element_blank(),\n        panel.grid.minor.x = element_blank(),\n        panel.grid.major.x = element_blank(),\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank(),\n        legend.position=\"bottom\") +\n  ylab(\"Scaled Distance to Hyperplane\") +\n  xlab(\"Rank of hacking interval midpoint\") +\n  scale_color_discrete(name=\"\")\n\np\n```\n\n\n```{r}\nif (save_figs){\nggsave(paste0(folder_out,\"svm_by_decile3.pdf\"),p,width = 8, height = 4, units = \"in\")\n}\n```\n\n------------\n## COMPAS score of 8\n\nNumber of people on either side of zero:\n```{r}\nsum(res_decile8$LB<0 & res_decile8$UB > 0 )/nrow(res_decile8)\n```\n\nHow many people had an interval below zero (and a high compas score in this case)?\n```{r}\nres_decile8 %>%\n  filter(UB < 0)\n```\n\nWhat can we say about this group on average?\n\n```{r}\nabove0_score8 = filter(propublica, id %in% res_decile8$id[res_decile8$LB>0]) %>%\n  summarize(n_people = n(), mean_prior=mean(priors_count), tot_recid=sum(two_year_recid))\nabove0_score8\n```\n\n\nOf the `r nrow(res_decile8)` people in our dataset with COMPAS scores of 8, `r above0_score8$n_people` of them had hacking intervals entirely below zero. That is, had SVM been used for prediction, any reasonable model would have predicted that they would not reoffend. The people had an average of `r above0_score8$mean_prior` priors and `r above0_score8$tot_recid` reoffend.\n\n#[I think all of the compas scores were good in this case. Most have pretty serious charges (like battery). The one who didn't reoffend has a serious criminal history so I think the score was ok]\n\n\nFraction that reoffend:\n```{r}\nres_decile8 %>%\n  summarize(mean(two_year_recid))\n```\n\nFraction that reoffend with an upper bound below 0\n```{r}\nres_decile8 %>%\n  filter(UB < 0) %>%\n  summarize(mean(two_year_recid))\n```\n\nFraction that reoffend with a lower bound above 0\n```{r}\nres_decile8 %>%\n  filter(LB > 0) %>%\n  summarize(mean(two_year_recid))\n```\n\n```{r}\n# Some data processing for the plot\nds = .04\n\ndf8_plt <- res_decile8 %>%\n  mutate(mid=(LB+UB)/2) %>%\n  arrange(decile_score, mid) %>%\n  group_by(decile_score) %>%\n  mutate(rank = 1:n()) %>%\n  mutate(score_jitter = decile_score + ds*1:n() - ds*(n()+1)/2) %>%\n  mutate(two_year_recid = as.factor(two_year_recid)) %>%\n  mutate(is_recid_plt =  ifelse(two_year_recid==1,\"Reoffend\",\"\")) %>%\n  mutate(group = if_else(row_number()<=floor(nrow(res_decile8)/2),0,1))\n```\n\n\n\n\n\n\n```{r}\nann_line <- data.frame(x = 50, xend = 50, y = -4, yend = -2, group=0)\nann_text <- data.frame(x = 50, xend = 50, y = -4.2, yend = -2, group=0)\n\n\n\np <- ggplot(df8_plt, aes(x=rank)) +\n  geom_errorbar(aes(ymin=LB, ymax=UB, color=race),\n                width=.05) + \n  geom_point(aes(y=UB+.1, shape=is_recid_plt), size=.8) +\n  scale_shape_manual(values=c(32,16), name=element_blank()) + # values are for Reoffend character\n  geom_hline(yintercept=0, color='grey', linetype=2) +\n  #geom_segment(data=ann_line,aes(x = x, xend = xend, y = y, yend = yend), \n  #             colour = \"black\", size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  #geom_text(data=ann_text,aes(x=x,y=y,size=3),label=\"label\")+\n  facet_wrap(~group ,scales = \"free\",nrow=2) +\n  theme_bw() +\n  scale_x_continuous(expand=c(0.01,0.01)\n                     #                  breaks=seq(score_min,score_max),\n                     #                   limits=c(score_min-0.5, score_max+0.5),\n  )+\n  theme(strip.background = element_blank(),\n        strip.text = element_blank(),\n        #axis.title.x=element_blank(),\n        #axis.text.x=element_blank(),\n        #axis.ticks.x=element_blank(),\n        panel.grid.minor.x = element_blank(),\n        panel.grid.major.x = element_blank(),\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank(),\n        legend.position=\"bottom\") +\n  ylab(\"Scaled Distance to Hyperplane\") +\n  xlab(\"Rank of hacking interval midpoint\") +\n  scale_color_discrete(name=\"\")\n\np\n```\n\n\n```{r}\nif (save_figs){\nggsave(paste0(folder_out,\"svm_by_decile8.pdf\"),p,width = 8, height = 4, units = \"in\")\n}\n```\n\n\n```{r}\n\nggplot(df8_plt, aes(x=score_jitter)) +\n  geom_errorbar(aes(ymin=LB, ymax=UB, color=race),\n                width=.05) + \n  geom_point(aes(y=UB+.1, shape=is_recid_plt), size=.8) +\n  scale_shape_manual(values=c(32,16), name=element_blank()) + # values are for Reoffend character\n  geom_hline(yintercept=0, color='grey', linetype=2) +\n  theme_bw() +\n  scale_x_continuous(expand=c(0,0)\n   #                  breaks=seq(score_min,score_max),\n  #                   limits=c(score_min-0.5, score_max+0.5),\n  )+\n  theme(strip.background = element_blank(),\n        strip.text = element_blank(),\n        axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        axis.ticks.x=element_blank(),\n        panel.grid.minor.x = element_blank(),\n        panel.grid.major.x = element_blank(),\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank(),\n        legend.position=\"bottom\") +\n  ylab(\"Scaled Distance to Hyperplane\") +\n  scale_color_discrete(name=\"\")\n```\n\n\n------------\n\n\n```{r}\n# Some data processing for the plot\nds = .04\n\ndfr_plt <- res_race %>%\n  mutate(mid=(LB+UB)/2) %>%\n  mutate(race_num = as.numeric(as.factor(race))) %>%\n  arrange(race_num, mid) %>%\n  group_by(race_num) %>%\n  mutate(rank = 1:n()) %>%\n  mutate(x_jitter = race_num + ds*1:n() - ds*(n()+1)/2) %>%\n  mutate(two_year_recid = as.factor(two_year_recid)) %>%\n  mutate(is_recid_plt =  ifelse(two_year_recid==1,\"Reoffend\",\"\"))\n```\n\n\n\n```{r}\nx_min = min(dfr_plt$race_num)\nx_max = max(dfr_plt$race_num)\n\n#c(4280,730,5749)\nid_ann <- c(4704, 2825, 4772, 8731, 9346, 10258, 3338, 4280,730,5749)\n\n#id_ann <- c(4704, 2825, 4772, 8731, 9346, 10258, 3338, 7534, 6749)\n#id_ann <- c(4704, 2825, 4772, 8731, 9346, 10258, 3338, 2523, 4280, 3114)\nann_line <- filter(dfr_plt, id%in%id_ann) %>%\n  mutate(yend = UB+.5)\nann_text <- left_join(ann_line,propublica,by=\"id\") %>% ungroup()\n\np <- ggplot(dfr_plt, aes(x=x_jitter)) +\n  #geom_segment(data=ann_line,aes(x = x_jitter, xend = x_jitter, y = 10, yend = 0,color=factor(id)), \n  #             size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  geom_text(data=ann_text, aes(x=x_jitter, y=6.5, label=name),angle=90,hjust='left',size=2)+\n  geom_segment(data=ann_line,aes(x = x_jitter, xend = x_jitter, y = 6, yend = yend), \n               color='black',size=.5, arrow=arrow(length=unit(0.15,\"cm\")))+\n  geom_errorbar(aes(ymin=LB, ymax=UB, color=score_text),\n                width=.05) + \n  geom_point(aes(y=UB+.1, shape=is_recid_plt), size=.8) +\n  scale_shape_manual(values=c(32,16), name=element_blank()) + # values are for Reoffend character\n  geom_hline(yintercept=0, color='grey', linetype=2) +\n  theme_bw() +\n  scale_x_continuous(breaks=seq(x_min,x_max),\n                     limits=c(x_min-0.5, x_max+0.5),\n                     expand=c(0,0),\n                     labels=unique(dfr_plt$race))+\n  theme(panel.grid.major.x = element_line(colour=\"white\", size=0.5),\n        panel.grid.major.y = element_blank(),\n        panel.grid.minor.y = element_blank(),\n        legend.position=\"bottom\") +\n  xlab(\"Race\") +\n  ylab(\"Scaled Distance to Hyperplane\") +\n  scale_color_discrete(name=\"\")\n  scale_color_discrete(name = \"COMPAS score\")\n\np\n```\n\n```{r}\nif (save_figs){\nggsave(paste0(folder_out,\"svm_by_race.pdf\"),p,width = 8, height = 4, units = \"in\")\n}\n```\n\n\n\n##### For decile chart\n40\nVictor Moreno, a 31 year old African American male, received a COMPAS score of 10 despite zero priors. However, the arrest related to his COMPAS score calculation included felony charges of battery, tampering with a victim, tampering with physical evidence, and delivering cocaine. Our SVM model, without access to the content of these charges, not surprisingly gave him a low hacking interval given his lack of prior offenses.\n```{r}\nres_decile %>%\n  filter(id==40)\n```\n\n\n7534\ndaniel chiswell, a 41-year old caucasian male, was assigned a COMPAS score of 1 after being charged with felony posession of heroin. He had previously been charged with felony battery on an officer. His hacking interval overlapped with zero . He was charged again with felony posession of heroin later that year.\n```{r}\nres_decile %>%\n  filter(id==7534)\n```\n\n6749\nvalentina parrish, a 21 year old caucasian female, was charged with driving under the influence and possesion of less than 20 grams of cannabis. She was given a COMPAS score of 10. Hacking interval was , so on either side of zero.\n```{r}\nres_decile %>%\n  filter(id==6749)\n```\n\n\n8731\nGregory Lugo. Low score, low hacking interval. No priors. However, propublica says he has 3 DUIs. (There are 3 charges in the charge database that are some kind of DUI and have a different case number from his c_case_number, but the date is the same as the c_charge_date (and confirmed with clerk website)... so are those really priors?)\n```{r}\nres_decile %>%\n  filter(id==8731)\n```\n\n\n4797\nclaudio tamarez\nPossession Of Phentermine\nCaucasian \n30 years old\nhacking above zero, COMPAS socre of 4 (low risk)\n9 priors, including battery on an officer \n```{r}\nres_decile %>%\n  filter(id==4797)\n```\n\n\n\n\n\n\n##### For race chart\n\n4280\nedwin chaj. a 27 year old Hispanic male, received a COMPAS score of 9 after he was charged with disorderly intoxication. He had only one prior related to trespassing. Hacking interval not entirely below zero, but it was close. He did not recidivate.\n```{r}\nres_race %>%\n  filter(id==4280)\n```\n\n\n730\ncuong do, 32 year odl Asian male, no priors, compas score 8, hacking interval below zero. Did no recidivate. Charged with felony burglary and misdomeanor petit theft.\n```{r}\nres_race %>%\n  filter(id==730)\n```\n\n\n5749\nmories abdo, a 27 year old Asian male has 6 priors, compas score 3, hacking above zero. Did not recidivate. Charged with battery. Can't find severe very severe priors, though.\n\n```{r}\nres_race %>%\n  filter(id==5749)\n```\n\n#### Information from databases\n\nUseful for manually looking up people.\n\n```{r, message=FALSE}\nfolder_in_db <- paste0(folder_home,\"Data/2_from_db/\")\n\ndb_casearrest <- read_csv(paste0(folder_in_db,\"db_casearrest.csv\"))\ndb_charge <- read_csv(paste0(folder_in_db,\"db_charge.csv\"))\ndb_jailhistory <- read_csv(paste0(folder_in_db,\"db_jailhistory.csv\"))\ndb_prisonhistory <- read_csv(paste0(folder_in_db,\"db_prisonhistory.csv\"))\n```\n\n\n```{r}\n#id0 <- c(4280,730,5749)\nid0 <- c(5749)\n\nView(filter(db_casearrest, person_id %in% id0))\nView(filter(db_charge, person_id %in% id0))\nView(filter(db_jailhistory, person_id %in% id0))\nView(filter(db_prisonhistory, person_id %in% id0))\nView(filter(propublica, id %in% id0))\n```\n\n",
    "created" : 1520470335659.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3399992718",
    "id" : "F969D096",
    "lastKnownWriteTime" : 1521434511,
    "last_content_update" : 1521434511210,
    "path" : "~/Documents/Duke_MSS/Range_of_Effects/hacking_intervals/Recidivism/Code/2_svm/R_plots/recidivism_plots.Rmd",
    "project_path" : "recidivism_plots.Rmd",
    "properties" : {
        "chunk_output_type" : "inline"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}